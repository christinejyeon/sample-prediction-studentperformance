thedata <- read.csv(file="student-mat.csv",header=TRUE,sep=";")
library(ggplot2)
library(RColorBrewer)
pal <- brewer.pal(9,"Set1")

library(tree)
set.seed(1234)
sampling <- sample(2, nrow(thedata), replace=TRUE, prob=c(0.7,0.3))
trainData <- thedata[sampling==1,]
testData <- thedata[sampling==2,]
tree1 <- tree(G1 ~ sex+age+address+famsize+Pstatus+Medu+Fedu+Mjob+reason+guardian+traveltime+studytime+failures+schoolsup+famsup+paid+activities+nursery+higher+internet+romantic+famrel+freetime+goout+Dalc+Walc+health+absences, data=trainData)
tree2 <- tree(G2 ~ sex+age+address+famsize+Pstatus+Medu+Fedu+Mjob+reason+guardian+traveltime+studytime+failures+schoolsup+famsup+paid+activities+nursery+higher+internet+romantic+famrel+freetime+goout+Dalc+Walc+health+absences, data=trainData)
tree3 <- tree(G3 ~ sex+age+address+famsize+Pstatus+Medu+Fedu+Mjob+reason+guardian+traveltime+studytime+failures+schoolsup+famsup+paid+activities+nursery+higher+internet+romantic+famrel+freetime+goout+Dalc+Walc+health+absences, data=trainData)
print(tree1)
print(tree2)
print(tree3)

plot(tree1)
text(tree1, col=pal)
plot(tree2)
text(tree2, col=pal)
plot(tree3)
text(tree3, col=pal)

tree1_cv <- cv.tree(tree1, FUN=prune.tree)
tree2_cv <- cv.tree(tree2, FUN=prune.tree)
tree3_cv <- cv.tree(tree3, FUN=prune.tree)
print(tree1_cv)
plot(tree1_cv, col=pal)
print(tree2_cv)
plot(tree2_cv, col=pal)
print(tree3_cv)
plot(tree3_cv, col=pal)

tree1_3 <- prune.tree(tree1, best=3)
print(tree1_3)
plot(tree1_3, type="u")
text(tree1_3, col=pal)
tree2_3 <- prune.tree(tree2, best=3)
print(tree2_3)
plot(tree2_3, type="u")
text(tree2_3, col=pal)
tree3_5 <- prune.tree(tree3, best=5)
print(tree3_5)
plot(tree3_5, type="u")
text(tree3_5, col=pal)

sampling2 <- sample(2, nrow(thedata), replace=TRUE, prob=c(0.7,0.3))
trainData2 <- thedata[sampling2==1,]
testData2 <- thedata[sampling2==2,]
thedata$average <- round((thedata$G1 + thedata$G2 + thedata$G3)/3,0)
tree4 <- tree(average ~ sex+age+address+famsize+Pstatus+Medu+Fedu+Mjob+reason+guardian+traveltime+studytime+failures+schoolsup+famsup+paid+activities+nursery+higher+internet+romantic+famrel+freetime+goout+Dalc+Walc+health+absences, data=trainData2)
print(tree4)
plot(tree4)
text(tree4, col=pal)
tree4_cv <- cv.tree(tree4, FUN=prune.tree)
print(tree4_cv)
plot(tree4_cv)

tree4_3 <- prune.tree(tree4, best=3)
print(tree4_3)
plot(tree4_3, type="u")
text(tree4_3, col=pal)

tree5 <- tree(average ~ sex+age+address+famsize+Pstatus+Medu+Fedu+Mjob+reason+guardian+traveltime+studytime+schoolsup+famsup+paid+activities+nursery+higher+internet+romantic+famrel+freetime+goout+Dalc+Walc+health+absences, data=trainData2)
tree5_cv <- cv.tree(tree5, FUN=prune.tree)
print(tree5_cv)
tree5_17 <- prune.tree(tree5, best=17)
print(tree5_17)
plot(tree5_17, type="u")
text(tree5_17, col=pal)
tree6 <- cv.tree(tree5_17, FUN=prune.tree)
print(tree6)
print6_1 <- prune.tree(tree6, best=2)
print(tree5)
plot(tree5, type="u")
text(tree5, col=pal)

newdata <- thedata
newdata$grade <- ifelse(newdata$average>=17,"Excellent", ifelse(newdata$average>=14,"Good", ifelse(newdata$average>=11,"Fair", ifelse(newdata$average>=8,"Poor", "Fail"))))
newdata$grade <- as.factor(newdata$grade)

sampling3 <- sample(2, nrow(newdata), replace=TRUE, prob=c(0.7,0.3))
trainData3 <- newdata[sampling3==1,]
testData3 <- newdata[sampling3==2,]
newtree <- tree(grade ~ sex+age+address+famsize+Pstatus+Medu+Fedu+Mjob+reason+guardian+traveltime+studytime+failures+schoolsup+famsup+paid+activities+nursery+higher+internet+romantic+famrel+freetime+goout+Dalc+Walc+health+absences, data=trainData3)
print(newtree)
plot(newtree, type="u")
text(newtree, col=pal)
newtree_cv <- cv.tree(newtree, FUN=prune.tree)
print(newtree_cv)
plot(newtree_cv)
newtree_final <- prune.tree(newtree, best=7)
print(newtree_final)
plot(newtree_final, type="u")
text(newtree_final, col=pal)

newtree_pre <- predict(newtree_final, newdata = testData3, type="class")
table(newtree_pre, testData3$grade)
confusionMatrix(newtree_pre, testData3$grade)
